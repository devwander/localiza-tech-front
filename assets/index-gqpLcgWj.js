import{r as n,j as e,k as z,u as O,l as $,m as q,n as V,o as P,p as U,q as H,s as Q,y as g,t as _,L as K,C as Z}from"./index-fgLeOBi-.js";import{u as G,T as J,S as X}from"./Toolbar-CQ0rCbrf.js";import{M as S,a as Y,c as ee,b as ae}from"./map.model-CEvP_qPJ.js";function se({title:t,titleId:l,...r},i){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:i,"aria-labelledby":l},r),t?n.createElement("title",{id:l},t):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m4.5 12.75 6 6 9-13.5"}))}const te=n.forwardRef(se);function re({title:t,titleId:l,...r},i){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:i,"aria-labelledby":l},r),t?n.createElement("title",{id:l},t):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z"}))}const ne=n.forwardRef(re);function oe({isOpen:t,onClose:l,onSaveAndExit:r,onExitWithoutSaving:i,isSaving:o=!1}){return t?e.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:e.jsxs("div",{className:"flex min-h-screen items-center justify-center p-4",children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 transition-opacity",onClick:o?void 0:l}),e.jsxs("div",{className:"relative bg-white rounded-lg shadow-xl max-w-md w-full p-6",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"AlteraÃ§Ãµes nÃ£o salvas"}),e.jsx("p",{className:"text-gray-600",children:"VocÃª possui alteraÃ§Ãµes que ainda nÃ£o foram salvas no banco de dados. O que deseja fazer?"})]}),e.jsxs("div",{className:"flex flex-col space-y-3",children:[e.jsx("button",{onClick:r,disabled:o,className:"w-full px-4 py-2.5 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium",children:o?e.jsxs("span",{className:"flex items-center justify-center",children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Salvando..."]}):"ðŸ’¾ Salvar e Sair"}),e.jsx("button",{onClick:i,disabled:o,className:"w-full px-4 py-2.5 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium",children:"âš ï¸ Sair sem Salvar"}),e.jsx("button",{onClick:l,disabled:o,className:"w-full px-4 py-2.5 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium",children:"â† Continuar Editando"})]})]})]})}):null}function le({isOpen:t,onClose:l,onSave:r,currentTags:i,isLoading:o=!1}){const[p,j]=n.useState(i);if(!t)return null;const f=a=>{j(c=>c.includes(a)?c.filter(u=>u!==a):[...c,a])},y=()=>{r(p),l()},m=()=>{o||(j(i),l())};return e.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:e.jsxs("div",{className:"flex min-h-screen items-center justify-center p-4",children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 transition-opacity",onClick:m}),e.jsxs("div",{className:"relative bg-white rounded-lg shadow-xl max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Editar Tags"}),e.jsx("button",{onClick:m,disabled:o,className:"text-gray-400 hover:text-gray-600 disabled:opacity-50",children:e.jsx("svg",{className:"h-6 w-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Selecione as tags para este mapa"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Object.entries(S).map(([a,c])=>e.jsx("button",{type:"button",onClick:()=>f(a),disabled:o,className:`px-3 py-1.5 text-sm font-medium rounded-full transition-all ${p.includes(a)?"bg-blue-600 text-white hover:bg-blue-700":"bg-gray-100 text-gray-700 hover:bg-gray-200"} disabled:opacity-50 disabled:cursor-not-allowed`,children:c},a))}),e.jsx("p",{className:"mt-2 text-xs text-gray-500",children:p.length>0?`${p.length} tag(s) selecionada(s)`:"Nenhuma tag selecionada"})]})}),e.jsxs("div",{className:"mt-6 flex space-x-3 justify-end",children:[e.jsx("button",{type:"button",onClick:m,disabled:o,className:"px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:"Cancelar"}),e.jsx("button",{type:"button",onClick:y,disabled:o,className:"px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:"Salvar"})]})]})]})})}function me(){const{id:t}=z(),l=O(),r=t==="new",i=$(),{data:o,isLoading:p,isError:j}=q(r?void 0:t),{data:f}=V(!r&&t?{mapId:t,limit:1e3}:void 0),y=Y(),m=ee(),a=G(),c=n.useRef(!1),u=n.useRef(!0),[v,x]=n.useState(!1),[T,N]=n.useState(!1),[L,k]=n.useState(!1),[b,C]=n.useState([]),[F,M]=n.useState(!1);n.useEffect(()=>{c.current=!1,x(!1),u.current=!0},[t]),n.useEffect(()=>{if(o&&!c.current&&!r){const{layers:s,nextId:d}=P(o);C(o.tags||[]);let h=s;f?.data&&f.data.length>0&&(h=U(s,f.data)),u.current=!0,a.loadLayers(h,d,t),c.current=!0,x(!1)}},[o,r,a,t,f]),n.useEffect(()=>{if(u.current){u.current=!1;return}if(r){x(!0);return}t&&c.current&&x(!0)},[a.layers,r,t]);const E=n.useCallback(async()=>{try{if(r){const s=o?.name||"Mapa sem nome",d=H(a.layers,s),h=await y.mutateAsync(d);if(!h?._id)throw new Error("Resposta invÃ¡lida da API ao criar mapa");await i.invalidateQueries({queryKey:["maps"],exact:!1}),await i.ensureQueryData({queryKey:["map",h._id],queryFn:()=>Q.map.findOne(h._id)}),u.current=!0,x(!1),g.success("Mapa criado com sucesso!"),l(`/dashboard/maps/${h._id}`,{replace:!0})}else if(t){const s=_(a.layers);b.length>0&&(s.tags=b),await m.mutateAsync({id:t,data:s}),x(!1),g.success("Mapa salvo com sucesso!")}}catch(s){console.error("Error saving map:",s),g.error("Erro ao salvar mapa")}},[a,r,t,o,b,y,m,l,i]),A=()=>{if(!v){l("/dashboard/maps");return}N(!0)},B=async()=>{try{await E(),l("/dashboard/maps")}catch(s){console.error("Erro ao salvar antes de sair:",s)}},R=()=>{N(!1),l("/dashboard/maps")},D=()=>{N(!1)},I=async()=>{if(!t||r){g.warning("Salve o mapa antes de compartilhar");return}const s=`${window.location.origin}/maps/public/${t}`;try{await navigator.clipboard.writeText(s),k(!0),g.success("Link pÃºblico copiado!"),setTimeout(()=>{k(!1)},2e3)}catch(d){console.error("Failed to copy:",d),g.error("Erro ao copiar link")}},W=s=>{C(s),x(!0),g.success("Tags atualizadas! Salve o mapa para aplicar as alteraÃ§Ãµes.")};if(p&&!r)return e.jsx(K,{});if(j&&!r)return e.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-md max-w-md",children:[e.jsx("h2",{className:"text-xl font-bold text-red-600 mb-4",children:"Erro ao carregar mapa"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"NÃ£o foi possÃ­vel carregar o mapa solicitado."}),e.jsx("button",{onClick:()=>l("/dashboard/maps"),className:"w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Voltar para lista de mapas"})]})});const w=y.isPending||m.isPending;return e.jsxs("div",{className:"h-screen bg-gray-100 flex flex-col overflow-hidden pt-[56px] md:pt-[64px]",children:[e.jsx("header",{className:"bg-white shadow-sm border-b flex-shrink-0",children:e.jsx("div",{className:"px-4 sm:px-6",children:e.jsxs("div",{className:"flex justify-between items-center h-14",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("button",{onClick:A,className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors",children:"â† Voltar"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h1",{className:"text-lg font-semibold text-gray-900",children:r?"Novo Mapa":o?.name||"Editando Mapa"}),!r&&b.length>0&&e.jsx("div",{className:"flex gap-1 mt-1",children:b.map(s=>e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${ae[s]}`,children:S[s]},s))})]}),!r&&e.jsx("button",{onClick:()=>M(!0),className:"ml-2 inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded-md text-gray-600 bg-white hover:bg-gray-50 transition-colors",title:"Editar tags",children:"ðŸ·ï¸ Tags"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("button",{onClick:E,disabled:w,className:`inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-semibold rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all ${w?"bg-gray-400":v?"bg-green-600 hover:bg-green-700 shadow-lg":"bg-blue-600 hover:bg-blue-700"}`,title:v?"Salvar alteraÃ§Ãµes no banco de dados":"Tudo salvo no banco de dados",children:[w?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-1.5 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Salvando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4 mr-1.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"})}),v?e.jsxs(e.Fragment,{children:["Salvar"," ",e.jsx("span",{className:"hidden xl:inline",children:"AlteraÃ§Ãµes"})]}):"Salvo"]}),v&&!w&&e.jsx("span",{className:"ml-1.5 text-xs",children:"âš ï¸"})]}),!r&&e.jsx("button",{onClick:I,className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors",title:"Compartilhar link pÃºblico",children:L?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-4 h-4 mr-1.5 text-green-600"}),e.jsx("span",{className:"hidden lg:inline text-green-600",children:"Copiado!"})]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"w-4 h-4 mr-1.5"}),e.jsx("span",{className:"hidden lg:inline",children:"Compartilhar"})]})}),e.jsxs("label",{className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 cursor-pointer transition-colors",children:[e.jsx("span",{className:"hidden lg:inline",children:"ðŸ–¼ï¸ Planta"}),e.jsx("span",{className:"lg:hidden",children:"ðŸ–¼ï¸"}),e.jsx("input",{type:"file",accept:"image/*",onChange:s=>{const d=s.target.files?.[0];d&&a.uploadBackgroundImage&&a.uploadBackgroundImage(d).catch(console.error),s.currentTarget.value=""},className:"sr-only"})]}),a.backgroundMeta&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"range",min:0,max:1,step:.05,value:a.backgroundMeta.opacity,onChange:s=>a.setBackgroundOpacity?.(Number(s.target.value)),className:"w-24"}),e.jsx("button",{onClick:()=>a.removeBackgroundImage?.(),title:"Remover rascunho",className:"px-2 py-1 text-sm border rounded-md bg-red-50 text-red-700 hover:bg-red-100 transition-colors",children:"âœ•"})]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.debugMode,onChange:a.toggleDebugMode,className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"ml-2 text-sm text-gray-700 hidden lg:inline",children:"Debug"})]})]})]})})}),e.jsx(J,{currentTool:a.currentTool,currentLayer:a.currentLayer,onToolChange:a.setTool,onLayerChange:a.setDrawMode}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsx("div",{className:"flex-1 flex items-center justify-center p-2 min-h-0",children:e.jsx("div",{className:"w-full h-full bg-white rounded-lg shadow-sm border",children:e.jsx(Z,{canvasRef:a.canvasRef})})}),e.jsx(X,{layers:a.layers,selectedElement:a.selectedElement,onUpdateElement:a.updateElement,onDeleteElement:s=>a.deleteElement(s),debugMode:a.debugMode,debugInfo:a.debugInfo})]}),e.jsx(oe,{isOpen:T,onClose:D,onSaveAndExit:B,onExitWithoutSaving:R,isSaving:w}),e.jsx(le,{isOpen:F,onClose:()=>M(!1),onSave:W,currentTags:b,isLoading:!1})]})}export{me as MapEditor};
